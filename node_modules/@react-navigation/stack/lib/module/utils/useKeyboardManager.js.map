{"version":3,"sources":["useKeyboardManager.tsx"],"names":["React","Keyboard","TextInput","useKeyboardManager","isEnabled","previouslyFocusedTextInputRef","useRef","undefined","startTimestampRef","keyboardTimeoutRef","clearKeyboardTimeout","useCallback","current","clearTimeout","onPageChangeStart","input","State","currentlyFocusedInput","blur","Date","now","onPageChangeConfirm","force","dismiss","onPageChangeCancel","setTimeout","focus","useEffect"],"mappings":"AAAA,OAAO,KAAKA,KAAZ,MAAuB,OAAvB;AACA,SAAwBC,QAAxB,EAAkCC,SAAlC,QAAmD,cAAnD;AAIA,eAAe,SAASC,kBAAT,CAA4BC,SAA5B,EAAsD;AACnE;AACA;AACA,QAAMC,6BAA6B,GAAGL,KAAK,CAACM,MAAN,CAAuBC,SAAvB,CAAtC;AACA,QAAMC,iBAAiB,GAAGR,KAAK,CAACM,MAAN,CAAqB,CAArB,CAA1B;AACA,QAAMG,kBAAkB,GAAGT,KAAK,CAACM,MAAN,EAA3B;AAEA,QAAMI,oBAAoB,GAAGV,KAAK,CAACW,WAAN,CAAkB,MAAM;AACnD,QAAIF,kBAAkB,CAACG,OAAnB,KAA+BL,SAAnC,EAA8C;AAC5CM,MAAAA,YAAY,CAACJ,kBAAkB,CAACG,OAApB,CAAZ;AACAH,MAAAA,kBAAkB,CAACG,OAAnB,GAA6BL,SAA7B;AACD;AACF,GAL4B,EAK1B,EAL0B,CAA7B;AAOA,QAAMO,iBAAiB,GAAGd,KAAK,CAACW,WAAN,CAAkB,MAAM;AAChD,QAAI,CAACP,SAAS,EAAd,EAAkB;AAChB;AACD;;AAEDM,IAAAA,oBAAoB;AAEpB,UAAMK,KAAe,GAAGb,SAAS,CAACc,KAAV,CAAgBC,qBAAhB,EAAxB,CAPgD,CAShD;;AACAF,IAAAA,KAAK,SAAL,IAAAA,KAAK,WAAL,YAAAA,KAAK,CAAEG,IAAP,GAVgD,CAYhD;;AACAb,IAAAA,6BAA6B,CAACO,OAA9B,GAAwCG,KAAxC,CAbgD,CAehD;;AACAP,IAAAA,iBAAiB,CAACI,OAAlB,GAA4BO,IAAI,CAACC,GAAL,EAA5B;AACD,GAjByB,EAiBvB,CAACV,oBAAD,EAAuBN,SAAvB,CAjBuB,CAA1B;AAmBA,QAAMiB,mBAAmB,GAAGrB,KAAK,CAACW,WAAN,CACzBW,KAAD,IAAoB;AAClB,QAAI,CAAClB,SAAS,EAAd,EAAkB;AAChB;AACD;;AAEDM,IAAAA,oBAAoB;;AAEpB,QAAIY,KAAJ,EAAW;AACT;AACA;AACA;AACArB,MAAAA,QAAQ,CAACsB,OAAT;AACD,KALD,MAKO;AACL,YAAMR,KAAK,GAAGV,6BAA6B,CAACO,OAA5C,CADK,CAGL;AACA;;AACAG,MAAAA,KAAK,SAAL,IAAAA,KAAK,WAAL,YAAAA,KAAK,CAAEG,IAAP;AACD,KAlBiB,CAoBlB;;;AACAb,IAAAA,6BAA6B,CAACO,OAA9B,GAAwCL,SAAxC;AACD,GAvByB,EAwB1B,CAACG,oBAAD,EAAuBN,SAAvB,CAxB0B,CAA5B;AA2BA,QAAMoB,kBAAkB,GAAGxB,KAAK,CAACW,WAAN,CAAkB,MAAM;AACjD,QAAI,CAACP,SAAS,EAAd,EAAkB;AAChB;AACD;;AAEDM,IAAAA,oBAAoB,GAL6B,CAOjD;;AACA,UAAMK,KAAK,GAAGV,6BAA6B,CAACO,OAA5C;;AAEA,QAAIG,KAAJ,EAAW;AACT;AAEA;AACA;AACA;AACA;AACA;AACA,UAAII,IAAI,CAACC,GAAL,KAAaZ,iBAAiB,CAACI,OAA/B,GAAyC,GAA7C,EAAkD;AAChDH,QAAAA,kBAAkB,CAACG,OAAnB,GAA6Ba,UAAU,CAAC,MAAM;AAC5CV,UAAAA,KAAK,SAAL,IAAAA,KAAK,WAAL,YAAAA,KAAK,CAAEW,KAAP;AACArB,UAAAA,6BAA6B,CAACO,OAA9B,GAAwCL,SAAxC;AACD,SAHsC,EAGpC,GAHoC,CAAvC;AAID,OALD,MAKO;AACLQ,QAAAA,KAAK,SAAL,IAAAA,KAAK,WAAL,YAAAA,KAAK,CAAEW,KAAP;AACArB,QAAAA,6BAA6B,CAACO,OAA9B,GAAwCL,SAAxC;AACD;AACF;AACF,GA5B0B,EA4BxB,CAACG,oBAAD,EAAuBN,SAAvB,CA5BwB,CAA3B;AA8BAJ,EAAAA,KAAK,CAAC2B,SAAN,CAAgB,MAAM;AACpB,WAAO,MAAMjB,oBAAoB,EAAjC;AACD,GAFD,EAEG,CAACA,oBAAD,CAFH;AAIA,SAAO;AACLI,IAAAA,iBADK;AAELO,IAAAA,mBAFK;AAGLG,IAAAA;AAHK,GAAP;AAKD","sourcesContent":["import * as React from 'react';\nimport { HostComponent, Keyboard, TextInput } from 'react-native';\n\ntype InputRef = React.ElementRef<HostComponent<unknown>> | undefined;\n\nexport default function useKeyboardManager(isEnabled: () => boolean) {\n  // Numeric id of the previously focused text input\n  // When a gesture didn't change the tab, we can restore the focused input with this\n  const previouslyFocusedTextInputRef = React.useRef<InputRef>(undefined);\n  const startTimestampRef = React.useRef<number>(0);\n  const keyboardTimeoutRef = React.useRef<any>();\n\n  const clearKeyboardTimeout = React.useCallback(() => {\n    if (keyboardTimeoutRef.current !== undefined) {\n      clearTimeout(keyboardTimeoutRef.current);\n      keyboardTimeoutRef.current = undefined;\n    }\n  }, []);\n\n  const onPageChangeStart = React.useCallback(() => {\n    if (!isEnabled()) {\n      return;\n    }\n\n    clearKeyboardTimeout();\n\n    const input: InputRef = TextInput.State.currentlyFocusedInput();\n\n    // When a page change begins, blur the currently focused input\n    input?.blur();\n\n    // Store the id of this input so we can refocus it if change was cancelled\n    previouslyFocusedTextInputRef.current = input;\n\n    // Store timestamp for touch start\n    startTimestampRef.current = Date.now();\n  }, [clearKeyboardTimeout, isEnabled]);\n\n  const onPageChangeConfirm = React.useCallback(\n    (force: boolean) => {\n      if (!isEnabled()) {\n        return;\n      }\n\n      clearKeyboardTimeout();\n\n      if (force) {\n        // Always dismiss input, even if we don't have a ref to it\n        // We might not have the ref if onPageChangeStart was never called\n        // This can happen if page change was not from a gesture\n        Keyboard.dismiss();\n      } else {\n        const input = previouslyFocusedTextInputRef.current;\n\n        // Dismiss the keyboard only if an input was a focused before\n        // This makes sure we don't dismiss input on going back and focusing an input\n        input?.blur();\n      }\n\n      // Cleanup the ID on successful page change\n      previouslyFocusedTextInputRef.current = undefined;\n    },\n    [clearKeyboardTimeout, isEnabled]\n  );\n\n  const onPageChangeCancel = React.useCallback(() => {\n    if (!isEnabled()) {\n      return;\n    }\n\n    clearKeyboardTimeout();\n\n    // The page didn't change, we should restore the focus of text input\n    const input = previouslyFocusedTextInputRef.current;\n\n    if (input) {\n      // If the interaction was super short we should make sure keyboard won't hide again.\n\n      // Too fast input refocus will result only in keyboard flashing on screen and hiding right away.\n      // During first ~100ms keyboard will be dismissed no matter what,\n      // so we have to make sure it won't interrupt input refocus logic.\n      // That's why when the interaction is shorter than 100ms we add delay so it won't hide once again.\n      // Subtracting timestamps makes us sure the delay is executed only when needed.\n      if (Date.now() - startTimestampRef.current < 100) {\n        keyboardTimeoutRef.current = setTimeout(() => {\n          input?.focus();\n          previouslyFocusedTextInputRef.current = undefined;\n        }, 100);\n      } else {\n        input?.focus();\n        previouslyFocusedTextInputRef.current = undefined;\n      }\n    }\n  }, [clearKeyboardTimeout, isEnabled]);\n\n  React.useEffect(() => {\n    return () => clearKeyboardTimeout();\n  }, [clearKeyboardTimeout]);\n\n  return {\n    onPageChangeStart,\n    onPageChangeConfirm,\n    onPageChangeCancel,\n  };\n}\n"]}